{"version":3,"sources":["plural.js"],"names":[],"mappings":"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","file":"plural-compiled.js","sourcesContent":["'use strict';\n\nvar express = require('express');\nvar _ = require('lodash');\nvar pluralize = require('pluralize');\nvar write = require('./write');\nvar getFullURL = require('./get-full-url');\nvar utils = require('../utils');\n\nmodule.exports = function (db, name, opts) {\n  // Create router\n  var router = express.Router();\n\n  // Embed function used in GET /name and GET /name/id\n  function embed(resource, e) {\n    e && [].concat(e).forEach(function (externalResource) {\n      if (db.get(externalResource).value) {\n        var query = {};\n        var singularResource = pluralize.singular(name);\n        query[`${singularResource}${opts.foreignKeySuffix}`] = resource.id;\n        resource[externalResource] = db.get(externalResource).filter(query).value();\n      }\n    });\n  }\n\n  // Expand function used in GET /name and GET /name/id\n  function expand(resource, e) {\n    e && [].concat(e).forEach(function (innerResource) {\n      var plural = pluralize(innerResource);\n      if (db.get(plural).value()) {\n        var prop = `${innerResource}${opts.foreignKeySuffix}`;\n        resource[innerResource] = db.get(plural).getById(resource[prop]).value();\n      }\n    });\n  }\n\n  // GET /name\n  // GET /name?q=\n  // GET /name?attr=&attr=\n  // GET /name?_end=&\n  // GET /name?_start=&_end=&\n  // GET /name?_embed=&_expand=\n  function list(req, res, next) {\n    // Resource chain\n    var chain = db.get(name);\n\n    // Remove q, _start, _end, ... from req.query to avoid filtering using those\n    // parameters\n    var q = req.query.q;\n    var _start = req.query._start;\n    var _end = req.query._end;\n    var _page = req.query._page;\n    var _sort = req.query._sort;\n    var _order = req.query._order;\n    var _limit = req.query._limit;\n    var _embed = req.query._embed;\n    var _expand = req.query._expand;\n    delete req.query.q;\n    delete req.query._start;\n    delete req.query._end;\n    delete req.query._sort;\n    delete req.query._order;\n    delete req.query._limit;\n    delete req.query._embed;\n    delete req.query._expand;\n\n    // Automatically delete query parameters that can't be found\n    // in the database\n    Object.keys(req.query).forEach(function (query) {\n      var arr = db.get(name).value();\n      for (var i in arr) {\n        if (_.has(arr[i], query) || query === 'callback' || query === '_' || /_lte$/.test(query) || /_gte$/.test(query) || /_ne$/.test(query) || /_like$/.test(query)) return;\n      }\n      delete req.query[query];\n    });\n\n    if (q) {\n      // Full-text search\n      if (Array.isArray(q)) {\n        q = q[0];\n      }\n\n      q = q.toLowerCase();\n\n      chain = chain.filter(function (obj) {\n        for (var key in obj) {\n          var value = obj[key];\n          if (db._.deepQuery(value, q)) {\n            return true;\n          }\n        }\n      });\n    }\n\n    Object.keys(req.query).forEach(function (key) {\n      // Don't take into account JSONP query parameters\n      // jQuery adds a '_' query parameter too\n      if (key !== 'callback' && key !== '_') {\n        // Always use an array, in case req.query is an array\n        var arr = [].concat(req.query[key]);\n\n        chain = chain.filter(function (element) {\n          return arr.map(function (value) {\n            var isDifferent = /_ne$/.test(key);\n            var isRange = /_lte$/.test(key) || /_gte$/.test(key);\n            var isLike = /_like$/.test(key);\n            var path = key.replace(/(_lte|_gte|_ne|_like)$/, '');\n            // get item value based on path\n            // i.e post.title -> 'foo'\n            var elementValue = _.get(element, path);\n\n            // Prevent toString() failing on undefined or null values\n            if (elementValue === undefined || elementValue === null) {\n              return;\n            }\n\n            if (isRange) {\n              var isLowerThan = /_gte$/.test(key);\n\n              return isLowerThan ? value <= elementValue : value >= elementValue;\n            } else if (isDifferent) {\n              return value !== elementValue.toString();\n            } else if (isLike) {\n              return new RegExp(value, 'i').test(elementValue.toString());\n            } else {\n              return value === elementValue.toString();\n            }\n          }).reduce(function (a, b) {\n            return a || b;\n          });\n        });\n      }\n    });\n\n    // Sort\n    if (_sort) {\n      var _sortSet = _sort.split(',');\n      var _orderSet = (_order || '').split(',').map(function (s) {\n        return s.toLowerCase();\n      });\n      chain = chain.orderBy(_sortSet, _orderSet);\n    }\n\n    // Slice result\n    if (_end || _limit || _page) {\n      res.setHeader('X-Total-Count', chain.size());\n      res.setHeader('Access-Control-Expose-Headers', `X-Total-Count${_page ? ', Link' : ''}`);\n    }\n\n    if (_page) {\n      _page = parseInt(_page, 10);\n      _page = _page >= 1 ? _page : 1;\n      _limit = parseInt(_limit, 10) || 10;\n      var page = utils.getPage(chain.value(), _page, _limit);\n      var links = {};\n      var fullURL = getFullURL(req);\n\n      if (page.first) {\n        links.first = fullURL.replace(`page=${page.current}`, `page=${page.first}`);\n      }\n\n      if (page.prev) {\n        links.prev = fullURL.replace(`page=${page.current}`, `page=${page.prev}`);\n      }\n\n      if (page.next) {\n        links.next = fullURL.replace(`page=${page.current}`, `page=${page.next}`);\n      }\n\n      if (page.last) {\n        links.last = fullURL.replace(`page=${page.current}`, `page=${page.last}`);\n      }\n\n      res.links(links);\n      chain = _.chain(page.items);\n    } else if (_end) {\n      _start = parseInt(_start, 10) || 0;\n      _end = parseInt(_end, 10);\n      chain = chain.slice(_start, _end);\n    } else if (_limit) {\n      _start = parseInt(_start, 10) || 0;\n      _limit = parseInt(_limit, 10);\n      chain = chain.slice(_start, _start + _limit);\n    }\n\n    // embed and expand\n    chain = chain.cloneDeep().forEach(function (element) {\n      embed(element, _embed);\n      expand(element, _expand);\n    });\n\n    res.locals.data = chain.value();\n    next();\n  }\n\n  // GET /name/:id\n  // GET /name/:id?_embed=&_expand\n  function show(req, res, next) {\n    var _embed = req.query._embed;\n    var _expand = req.query._expand;\n    var resource = db.get(name).getById(req.params.id).value();\n\n    if (resource) {\n      // Clone resource to avoid making changes to the underlying object\n      var clone = _.cloneDeep(resource);\n\n      // Embed other resources based on resource id\n      // /posts/1?_embed=comments\n      embed(clone, _embed);\n\n      // Expand inner resources based on id\n      // /posts/1?_expand=user\n      expand(clone, _expand);\n\n      res.locals.data = clone;\n    }\n\n    next();\n  }\n\n  // POST /name\n  function create(req, res, next) {\n    var resource = db.get(name).insert(req.body).value();\n\n    res.setHeader('Access-Control-Expose-Headers', 'Location');\n    res.location(`${getFullURL(req)}/${resource.id}`);\n\n    res.status(201);\n    res.locals.data = resource;\n\n    next();\n  }\n\n  // PUT /name/:id\n  // PATCH /name/:id\n  function update(req, res, next) {\n    var id = req.params.id;\n    var chain = db.get(name);\n\n    chain = req.method === 'PATCH' ? chain.updateById(id, req.body) : chain.replaceById(id, req.body);\n\n    var resource = chain.value();\n\n    if (resource) {\n      res.locals.data = resource;\n    }\n\n    next();\n  }\n\n  // DELETE /name/:id\n  function destroy(req, res, next) {\n    var resource = db.get(name).removeById(req.params.id).value();\n\n    // Remove dependents documents\n    console.log({ opts });\n    var removable = db._.getRemovable(db.getState(), opts);\n    console.log(removable);\n    removable.forEach(function (item) {\n      db.get(item.name).removeById(item.id).value();\n    });\n\n    if (resource) {\n      res.locals.data = {};\n    }\n\n    next();\n  }\n\n  var w = write(db);\n\n  router.route('/').get(list).post(create, w);\n\n  router.route('/:id').get(show).put(update, w).patch(update, w).delete(destroy, w);\n\n  return router;\n};"]}